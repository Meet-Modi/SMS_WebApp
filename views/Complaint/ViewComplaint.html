<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>SDE | Complaint</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--===============================================================================================-->
    <link rel="icon" type="image/png" href="images/icons/logo.png"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="vendor/animsition/css/animsition.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="css/util.css">
    <link rel="stylesheet" type="text/css" href="css/custom.css">    
    <link rel="stylesheet" type="text/css" href="css/button.css">
    <!--===============================================================================================-->
    <!-- Font Awesome -->
    <link rel="stylesheet" href="Addcust_files/plugins/fontawesome-free/css/all.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- daterange picker -->
    <link rel="stylesheet" href="Addcust_files/plugins/daterangepicker/daterangepicker.css">
    <!-- iCheck for checkboxes and radio inputs -->
    <link rel="stylesheet" href="Addcust_files/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
    <!-- Bootstrap Color Picker -->
    <link rel="stylesheet" href="Addcust_files/plugins/bootstrap-colorpicker/css/bootstrap-colorpicker.min.css">
    <!-- Tempusdominus Bbootstrap 4 -->
    <link rel="stylesheet" href="Addcust_files/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
    <!-- Select2 -->
    <link rel="stylesheet" href="Addcust_files/plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="Addcust_files/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
    <!-- Bootstrap4 Duallistbox -->
    <link rel="stylesheet" href="Addcust_files/plugins/bootstrap4-duallistbox/bootstrap-duallistbox.min.css">
    <!-- Theme style --> 
    <link rel="stylesheet" href="Addcust_files/dist/css/adminlte.min.css">
    <!-- Google Font: Source Sans Pro -->
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
    
    <style>
        .form-control1 {
            display: block;
            width: 100%;
            height: calc(4.5rem + 2px);
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #ffffff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            box-shadow: inset 0 0 0 rgba(0, 0, 0, 0);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
    </style>
    
</head>

<body class="hold-transition sidebar-mini animsition">
    <?php
    $cookie_name = "jwt_token";
    
    if(isset($_COOKIE[$cookie_name])) { 
        echo "Cookie named '" . $cookie_name . "' is set!";
        $jwt_token = $_COOKIE[$cookie_name]; 
    } 
    else{
        header("Location: ../../index.html");
        exit();
    }		
    
    $myObj = (object)array();
    $myObj->jwt = $jwt_token;
    $myJSON = json_encode($myObj);
    
    $ch = curl_init();
    
    curl_setopt($ch, CURLOPT_URL,            "http://localhost/SMS_WebApp/api/employee/validate_token.php" );
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1 );
    curl_setopt($ch, CURLOPT_POST,           1 );
    curl_setopt($ch, CURLOPT_POSTFIELDS,     $myJSON ); 
    curl_setopt($ch, CURLOPT_HTTPHEADER,     array('Content-Type: text/plain')); 
    
    $result=curl_exec ($ch);
    $data = json_decode($result);
    $userid = $data->data->userid;
    $firstname = $data->data->firstname;
    $lastname = $data->data->lastname;
    
    $complaint_id = $_GET['complaint_id'];
    echo($complaint_id);
    $myObj = (object)array();
    $myObj->complaint_id = $complaint_id;
    $myObj->operation = "R";
    $myJSON = json_encode($myObj);
    
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL,            "http://localhost/SMS_WebApp/api/complaint/RD_complaint.php" );
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1 );
    curl_setopt($ch, CURLOPT_POST,           1 );
    curl_setopt($ch, CURLOPT_POSTFIELDS,     $myJSON ); 
    curl_setopt($ch, CURLOPT_HTTPHEADER,     array('Content-Type: text/plain')); 
    $result1=curl_exec ($ch);
    $result1=curl_exec ($ch);
    $data_complaint = json_decode($result1);
    echo($result1);
    $customer_id = $data_complaint->customerid;
    $billing_name = $data_complaint->billingname;
    $amc_id = $data_complaint->amcid;
    $date = $data_complaint->date;
    $complaint_type = $data_complaint->complainttype;
    $complaint_status = $data_complaint->status;
    $defect_observed=$data_complaint->defectobserved;
    $action_taken=$data_complaint->actiontaken;
    $parts_replaced=$data_complaint->partsreplaced;
    $remarks=$data_complaint->remarks;
    $line_voltage=$data_complaint->linevoltage;
    $grill_temp=$data_complaint->grilltemp;
    $current=$data_complaint->current;
    $room_temp=$data_complaint->roomtemp;
    $time_from=$data_complaint->timefrom;
    $time_to=$data_complaint->timeto;
    $mechanic_remarks=$data_complaint->mechanicremarks;
    $mechanic_name=$data_complaint->mechanicname;
    $customer_remarks=$data_complaint->customerremarks;
    $row = json_encode(array_merge(json_decode($result,true),json_decode($result1,true)));
    

    $inArray = (object)array();
    $inArray->view = "BillingName_AMC";
    $inJSON = json_encode($inArray);
    
    $ch = curl_init();
    
    curl_setopt($ch, CURLOPT_URL,            "http://localhost/SMS_WebApp/api/dynamicviews/dropdownviews.php" );
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1 );
    curl_setopt($ch, CURLOPT_POST,           1 );
    curl_setopt($ch, CURLOPT_POSTFIELDS,     $inJSON ); 
    curl_setopt($ch, CURLOPT_HTTPHEADER,     array('Content-Type: text/plain')); 
    
    $result1 =curl_exec ($ch);

    $inArray2 = (object)array();
    $inArray2->view = "ViewComplaint";
    $inJSON2 = json_encode($inArray2);
    
    $ch2= curl_init();
    
    curl_setopt($ch2, CURLOPT_URL,            "http://localhost/SMS_WebApp/api/dynamicviews/dropdownviews.php" );
    curl_setopt($ch2, CURLOPT_RETURNTRANSFER, 1 );
    curl_setopt($ch2, CURLOPT_POST,           1 );
    curl_setopt($ch2, CURLOPT_POSTFIELDS,     $inJSON2 ); 
    curl_setopt($ch2, CURLOPT_HTTPHEADER,     array('Content-Type: text/plain')); 
    
    $result2 =curl_exec ($ch2);
    $data2 = json_decode($result2);
    $name = $data2->mechanic;
    $complainttype = $data2->complainttype;

    $STATUS = array("OPEN","CLOSED");
    ?>
    <script>
        var userid = "<?php echo($userid);?>";
        var firstname = "<?php echo($firstname);?>";
        var lastname = "<?php echo($lastname); ?>";
        var amcid = "<?php echo($amc_id); ?>";
        var billingname = "<?php echo($billing_name); ?>";
    </script>
    <script>
        var stateObject = <?php echo($result1); ?>;
        window.onload = function () {
            var countySel = document.getElementById("billing_name"),
            stateSel = document.getElementById("amc_id");
            for (var country in stateObject) {                
                countySel.options[countySel.options.length] = new Option(country, country);                    
                if(country==billingname){
                    countySel.value = billingname;
                    stateSel.length = 0; // remove all options bar first
                    if (this.selectedIndex < 1) return; // done 
                    var state = stateObject[country];
                    for (var i = 0; i < state.length; i++) {
                        stateSel.options[stateSel.options.length] = new Option(state[i], state[i]);
                        if(state[i]==amcid){
                            stateSel.value = state[i];
                        }
                    }
                    
                }
            }
            countySel.onchange = function () {
                var e = document.getElementById("billing_name");
                console.log(e.selectedIndex);
                stateSel.length = 0; // remove all options bar first
                if (this.selectedIndex < 1) return; // done 
                var state = stateObject[this.value];
                for (var i = 0; i < state.length; i++) {
                    stateSel.options[stateSel.options.length] = new Option(state[i], state[i]);
                    if(state[i]==amcid){
                        stateSel.value = state[i];
                    }
                }
            }
            
        }
        
    </script>
    <div class="header1" id="navbar"></div>
    <div id="response"></div>
    <div class="wrapper">
        <section class="content">
            <div class="container-fluid">
                <div class="card card-default">
                    <div class="card-header row">
                        <div class="col-md-9">
                            <h3 class="card-title">View Complaint</h3>
                        </div>
                        <button class="print-button" id="print_button" style="position: relative; left: 260px;"><span class="print-icon" style="width: 40px; height: 22px;"></span></button>   
                        <div class="col-md-2">
                            <form id="view_complaint_form" method="POST">
                                <input type="submit" value="Update" class="btn btn-primary" style="position: relative;float: right;">
                            </div>
                        </div>
                        <div class="card-body" id="complaint">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="billing_name">Billing Name</label>
                                        <select class="form-control" style="width: 85%;" required="required" id="billing_name" name="billing_name">
                                         
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="fromdate">Date</label>
                                        <input type="date" class="form-control" style="width: 70%;" id="date" placeholder="date" name="date" value="<?php echo($date); ?>">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="amc_id">AMC ID</label>
                                        <select class="form-control" style="width: 50%;" id="amc_id" name="amc_id">
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="amctype">Complaint Type</label>
                                        <select id="complaint_type" class="form-control" style="width:85%;" name="complaint_type">                
                                        
                                        <?php 
                                            foreach($complainttype as $row){
                                                echo "<option";
                                                if($complaint_type == $row->complainttype){
                                                    echo " selected='selected'";
                                                }
                                                echo ">".$row->complainttype."</option>"; 
                                            }           
                                        ?>
                                        </select>
                                    </div>    
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="fromdate">Status</label>
                                        <select class="form-control" style="width:25%;" id="status" name="status">
                                            <?php 
                                                foreach($STATUS as $row){
                                                    echo "<option";
                                                    if($complaint_status == $row){
                                                        echo " selected='selected'";
                                                    }
                                                    echo ">".$row."</option>"; 
                                                }           
                                            ?>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="card-body" id="complaintreport" style="border-top-style: groove; border-width: 2px;">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="fromdate">Assigned to Mechanic</label>
                                        <input list="mechanic_name" class="form-control" style="width:40%;" value="<?php echo($mechanic_name); ?>" name="mechanic_name">                
                                        <?php
                                            echo ("<datalist id='mechanic_name'>");
                                            foreach($name as $row){
                                                echo "<option>".$row->name."</option>";
                                            }
                                            echo("</datalist>");
                                        ?>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="fromdate">Time From</label>
                                        <input type="datetime-local" class="form-control" style="width:80%;" id="time_from" value="<?php echo(date('Y-m-d\TH:i:s', strtotime($time_from))); ?>" name="time_from">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="fromdate">Time To</label>
                                        <input type="datetime-local" class="form-control" style="width:80%;" id="time_to" value="<?php echo(date('Y-m-d\TH:i:s', strtotime($time_to))); ?>" name="time_to">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="fromdate">Line Voltage</label>
                                                <input type="number" class="form-control" style="width:45%;" id="line_voltage" value="<?php echo($line_voltage); ?>" name="line_voltage">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="fromdate">Grill Temperature</label>
                                                <input type="number" class="form-control" style="width:45%;" id="grill_temp" value="<?php echo($grill_temp); ?>" name="grill_temp">
                                            </div>        
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="fromdate">Current</label>
                                                <input type="number" class="form-control" style="width:45%;" id="current" value="<?php echo($current); ?>" name="current">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="fromdate">Room Temperature</label>
                                                <input type="number" class="form-control" style="width:45%;" id="room_temp" value="<?php echo($room_temp); ?>" name="room_temp">
                                            </div>        
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">                                    
                                    <div class="form-group">
                                        <label for="fromdate">Defect Observed</label>
                                        <textarea class="form-control" cols="30" rows="3" style="width:100%;" id="defect_observed" name="defect_observed"><?php echo($defect_observed); ?></textarea>
                                    </div>                                    
                                    <div class="form-group">
                                        <label for="fromdate">Remarks</label>
                                        <textarea class="form-control" cols="30" rows="3" style="width:100%;" id="remarks" name="remarks"><?php echo($remarks); ?></textarea>
                                    </div>
                                </div>
                                <div class="col-md-4">                 
                                    <div class="form-group">
                                        <label for="fromdate">Action Taken</label>
                                        <textarea class="form-control" cols="30" rows="3" style="width:100%;" id="action_taken" name="action_taken"><?php echo($action_taken); ?></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="fromdate">Customer Remarks</label>
                                        <textarea class="form-control" cols="30" rows="3" style="width:100%;" id="customer_remarks" name="customer_remarks"><?php echo($customer_remarks); ?></textarea>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="fromdate">Part Replaced</label>
                                        <textarea class="form-control" cols="30" rows="3" style="width:100%;" id="parts_replaced" name="parts_replaced"><?php echo($parts_replaced); ?></textarea>
                                    </div>  
                                    <div class="form-group">
                                        <label for="fromdate">Mechanic Remarks</label>
                                        <textarea class="form-control" cols="30" rows="3" style="width:100%;" id="mechanic_remarks" name="mechanic_remarks"><?php echo($mechanic_remarks); ?></textarea>
                                    </div>                                  
                                </div>
                            </div>   
                            <div class="form-group">
                                <label for="operation"></label>
                                <input type="hidden" class="form-control" style="width:25%;" id="operation" value="U" name="operation">
                                <input type="hidden" class="form-control" style="width:0%" id="complaint_id" value="<?php echo($complaint_id); ?>" name="complaint_id">
                            </div> 
                        </div>
                        
                    </form>               
                </div>  
            </div>    
        </section>
    </div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="Addcust_files/plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="Addcust_files/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- Select2 -->
    <script src="Addcust_files/plugins/select2/js/select2.full.min.js"></script>
    <!-- Bootstrap4 Duallistbox -->
    <script src="Addcust_files/plugins/bootstrap4-duallistbox/jquery.bootstrap-duallistbox.min.js"></script>
    <!-- InputMask -->
    <script src="Addcust_files/plugins/moment/moment.min.js"></script>
    <script src="Addcust_files/plugins/inputmask/min/jquery.inputmask.bundle.min.js"></script>
    <!-- date-range-picker -->
    <script src="Addcust_files/plugins/daterangepicker/daterangepicker.js"></script>
    <!-- bootstrap color picker -->
    <script src="Addcust_files/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js"></script>
    <!-- Tempusdominus Bootstrap 4 -->
    <script src="Addcust_files/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
    <!-- Bootstrap Switch -->
    <script src="Addcust_files/plugins/bootstrap-switch/js/bootstrap-switch.min.js"></script>
    <!-- AdminLTE App -->
    <script src="Addcust_files/dist/js/adminlte.min.js"></script>
    <!-- AdminLTE for demo purposes -->
    <script src="Addcust_files/dist/js/demo.js"></script>
    <!-- Page script -->
    <!--===============================================================================================-->
    <script type="text/javascript" src="vendor/jquery/jquery-3.2.1.min.js"></script>
    <!--===============================================================================================-->
    <script type="text/javascript" src="vendor/animsition/js/animsition.min.js"></script>
    <!--===============================================================================================-->
    <script type="text/javascript" src="vendor/bootstrap/js/popper.js"></script>
    <script type="text/javascript" src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <!--===============================================================================================-->
    <script src="js/main.js"></script>
    <script src="../NavBar/NavBar.js"></script>
    <!--===============================================================================================-->
    <script type="text/javascript">
        $(document).ready(function(){
            showNavBar(userid,firstname,lastname);
            $('.js-show-header-dropdown').on('click', function(){
                $(this).parent().find('.header-dropdown')
            });
            
            var menu = $('.js-show-header-dropdown');
            var sub_menu_is_showed = -1;
            
            for(var i=0; i<menu.length; i++){
                $(menu[i]).on('click', function(){ 
                    
                    if(jQuery.inArray( this, menu ) == sub_menu_is_showed){
                        $(this).parent().find('.header-dropdown').toggleClass('show-header-dropdown');
                        sub_menu_is_showed = -1;
                    }
                    else {
                        for (var i = 0; i < menu.length; i++) {
                            $(menu[i]).parent().find('.header-dropdown').removeClass("show-header-dropdown");
                        }
                        
                        $(this).parent().find('.header-dropdown').toggleClass('show-header-dropdown');
                        sub_menu_is_showed = jQuery.inArray( this, menu );
                    }
                });
            }
            
            $(".js-show-header-dropdown, .header-dropdown").click(function(event){
                event.stopPropagation();
            });
            
            $(window).on("click", function(){
                for (var i = 0; i < menu.length; i++) {
                    $(menu[i]).parent().find('.header-dropdown').removeClass("show-header-dropdown");
                }
                sub_menu_is_showed = -1;
            });
            
            
            $("#print_button").click(function(){
                var update_customer_form=$("#view_complaint_form");
                function redirectPost(url, data) {
                    var form = document.createElement('form');
                    document.body.appendChild(form);
                    form.method = 'post';
                    form.action = url;
                    for (var name in data) {
                        var input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = name;
                        input.value = data[name];
                        form.appendChild(input);
                        console.log("{" + name + "," + data[name] + "}");
                    }
                    form.submit();
                }
                var form_data=JSON.stringify(update_customer_form.serializeObject());
//                redirectPost('http://localhost/SMS_WebApp/api/pdf_api/generate_report.php', update_customer_form.serializeObject());
                console.log(form_data);
            });
            
            
            $("#view_complaint_form").submit(function(){
                console.log("INSIDE");
                var update_customer_form=$(this);
                var form_data=JSON.stringify(update_customer_form.serializeObject());
                // submit form data to api
                console.log(form_data);
                $.ajax({
                    url: "http://localhost/SMS_WebApp/api/complaint/CU_complaint.php",
                    type : "POST",
                    contentType : 'application/json',
                    data : form_data,
                    
                    success : function(result){
                        $('#response').html("<div class='alert alert-success' style='postion:absolute; bottom:0px;'> Complaint Updated Successfully</div>");
                        //add_customer_form.find('input').val('');
                    },
                    error: function(xhr, status, error){
                        $('#response').html("<div class='alert alert-danger'>Unable to update Complaint.</div>");
                        // on error, tell the user login has failed & empty the input boxes
                    }
                });
                return false;
            });
            
            
            $.fn.serializeObject = function(){
                
                var o = {};
                var a = this.serializeArray();
                $.each(a, function() {
                    if (o[this.name] !== undefined) {
                        if (!o[this.name].push) {
                            o[this.name] = [o[this.name]];
                        }
                        o[this.name].push(this.value || '');
                    } else {
                        o[this.name] = this.value || '';
                    }
                });
                return o;
            };
            
        });
    </script>    
</body>
</html>
